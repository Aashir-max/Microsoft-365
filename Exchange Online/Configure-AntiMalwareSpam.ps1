##########################################################################################################################################################################################
## Description:
## This script configures anti-spam and anti-malware for Exchange Online
## e.g. to use, run: .\Configure-AntiMalwareSpam.ps1 -Alert alerts@itpromentor.com -Domain itpromentor.com,itpromentor.onmicrosoft.com
## If you do not specify parameters, the script will prompt you to provide the same
##
## Reference: https://docs.microsoft.com/en-us/exchange/antispam-and-antimalware/antispam-and-antimalware?view=exchserver-2019
## The changes implemented in this script correspond to The Office 365 Email Security Checklist
## 
## Prerequisites:
## The tenant will need any Exchange Online plan
## Connect to Exchange Online via PowerShell:
## Using MFA: https://docs.microsoft.com/en-us/powershell/exchange/exchange-online/clconnect-to-exchange-online-powershell/mfa-connect-to-exchange-online-powershell?view=exchange-ps
## 
## WARNING: Script provided as-is. Author is not responsible for its use and application. Use at your own risk.
##########################################################################################################################################################################################

Param (
    $Alert,
    $Domain   
)


if($Alert -eq $null -or $Alert -eq ""){

    $Alert = Read-Host -Prompt "Please specify an email address where you will receive security alerts"
    Write-Host
}


if($Domain -eq $null -or $Domain -eq ""){

    $Domain = Read-Host -Prompt "Please specify the recipient domain(s) that will be protected by these policies (comma separated)"
    Write-Host
}

Clear-Host



## Create the baseline spam filter policy and rule
$HostedContentPolicyParam = @{
    "name" = "Anti-spam Baseline";
    'bulkspamaction' =  'quarantine';
    'bulkthreshold' =  '7';
    'highconfidencespamaction' =  'quarantine';
    'inlinesafetytipsenabled' = $true;
    'markasspambulkmail' = 'on';
    'enablelanguageblocklist' = $true;
    'enableregionblocklist' = $true;
    'increasescorewithimagelinks' = 'off'
    'increasescorewithnumericips' = 'on'
    'increasescorewithredirecttootherport' = 'on'
    'increasescorewithbizorinfourls' = 'on';
    'markasspamemptymessages' ='on';
    'markasspamjavascriptinhtml' = 'on';
    'markasspamframesinhtml' = 'on';
    'markasspamobjecttagsinhtml' = 'on';
    'markasspamembedtagsinhtml' ='on';
    'markasspamformtagsinhtml' = 'on';
    'markasspamwebbugsinhtml' = 'off';
    'markasspamsensitivewordlist' = 'on';
    'markasspamspfrecordhardfail' = 'on';
    'markasspamfromaddressauthfail' = 'on';
    'markasspamndrbackscatter' = 'off';
    'phishspamaction' = 'quarantine';
    'spamaction' = 'quarantine';
    'zapenabled' = $true;
    'EnableEndUserSpamNotifications' = $true;
    'EndUserSpamNotificationFrequency' = 1;
    'QuarantineRetentionPeriod' = 15
}
New-HostedContentFilterPolicy @HostedContentPolicyParam

$HostedContentRuleParam = @{
    'name' = 'Anti-spam Baseline';
    'hostedcontentfilterpolicy' = 'Anti-spam baseline'; 
    'recipientdomainis' = $Domain; 
    'Enabled' = $true
}
New-HostedContentFilterRule @HostedContentRuleParam

## Create Baseline malware filter policy and rule
$MalwarePolicyParam = @{
    "Name" = "Anti-malware Baseline";
    'Action' =  'deletemessage';
    'Enablefilefilter' =  $true;
    'EnableInternalSenderAdminNotifications' = $true;
    'InternalSenderAdminAddress' =  $Alert;
    'Enableinternalsendernotifications' =  $true;
    'ZapEnabled' = $true
}
New-MalwareFilterPolicy @MalwarePolicyParam
    
### Note to self: need to scope recipient domain(s) to all accepted domains*
$MalwareRuleParam = @{
    'name' = 'Anti-malware Baseline';
    'malwarefilterpolicy' = 'Anti-malware Baseline'; 
    'recipientdomainis' = $Domain; 
    'Priority' = 0;
    'Enabled' = $true
}
    
New-MalwareFilterRule @MalwareRuleParam


## Modify existing 'Default' oubound spam filter
$OutboundPolicyParam = @{
    "identity" = 'Default';
    'bccsuspiciousoutboundadditionalrecipients' =  $Alert;
    'bccsuspiciousoutboundmail' = $true;
    'notifyoutboundspam' = $true;
    'NotifyOutboundSpamRecipients' = $Alert
}

Set-HostedOutboundSpamFilterPolicy @OutboundPolicyParam

